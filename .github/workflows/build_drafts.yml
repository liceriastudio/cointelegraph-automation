name: Build Draft Articles

on:
  workflow_dispatch:
  push:
    paths:
      - "output/*.json"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Make drafts from latest JSON
        run: |
          pip install python-slugify
          mkdir -p drafts
          python - <<'PY'
          import json, os, glob, datetime
          from slugify import slugify

          files = sorted(glob.glob("output/*.json"))
          if not files:
              print("No JSON found"); raise SystemExit(0)
          latest = files[-1]
          data = json.load(open(latest, "r", encoding="utf-8"))

          def md(article):
              title = article.get("title","").strip()
              link = article.get("link","").strip()
              summary = article.get("summary","").strip()
              now = datetime.datetime.utcnow().strftime("%Y-%m-%d")
              slug = slugify(title)[:80] or slugify(link)[:80]
              img_prompt = f"A clean modern illustration of: {title}. Abstract shapes, soft lighting, no logos/trademarks, editorial style."

              body = f"""---
title: "{title}"
date: {now}
slug: "{slug}"
meta_description: "{summary[:150].replace('"','')}"
tags: ["crypto","news"]
source: "{link}"
image_prompt: "{img_prompt}"
---

## TL;DR
- {summary[:200] or "Key points will be added after rewrite."}

## Kya naya hai
- (facts yahan add honge)

## Background
(short context)

## Sources
- {link}
"""
              return slug, body

          made = 0
          for a in data:
              slug, body = md(a)
              fn = f"drafts/{slug}.md"
              if not os.path.exists(fn):
                  open(fn,"w",encoding="utf-8").write(body)
                  made += 1
          print("Drafts created:", made)
          PY

      - name: Commit drafts
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add drafts || true
          git commit -m "Build drafts from latest JSON" || echo "No new drafts"
          git push || echo "Push skipped"
